<div class="chat-container">
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-input">
        <input type="text" id="chat-message" placeholder="Type a message..." />
        <button id="send-message">Send</button>
    </div>
</div>

<style>
    .chat-container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        border-radius: 8px;
        padding: 15px;
        box-sizing: border-box;
    }
    .chat-messages {
        flex: 1;
        background: var(--chat-bg);
        overflow-y: auto;
        padding: 10px;
        border-radius: 8px;
    }
    .message {
        margin: 10px 0;
        display: flex;
        flex-direction: column;
    }
    .my-message {
        margin-left: auto;
        align-items: flex-end;
    }
    .my-message .header {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        margin-bottom: 4px;
    }
    .my-message .username {
        margin-right: 10px;
    }
    .my-message .profile-photo {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 1px solid #ccc;
    }
    .my-message .message-box {
        background: var(--my-message-bg, #007BFF); /* Fallback to #007BFF if variable fails */
        color: #fff;
        border-radius: 8px 8px 0 8px;
        padding: 8px 12px;
        border: 2px solid #0056b3; /* Increased border thickness for visibility */
        display: inline-block;
        width: fit-content;
        max-width: 70%;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); /* Added shadow for better visibility */
    }
    .other-message {
        margin-right: auto;
        align-items: flex-start;
    }
    .other-message .header {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        margin-bottom: 4px;
    }
    .other-message .username {
        margin-right: 4px;
        margin-left: 10px;
    }
    .other-message .profile-photo {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 1px solid #ccc;
    }
    .other-message .message-box {
        background: var(--other-message-bg);
        color: var(--text-color);
        border-radius: 8px 8px 8px 0;
        padding: 8px 12px;
        border: 1px solid #ccc;
        display: inline-block;
        width: fit-content;
        max-width: 70%;
    }
    .dark .other-message .message-box {
        border-color: #555;
    }
    .dark .my-message .message-box {
        border-color: #135abe; /* Dark mode border for my-message */
    }
    .dark .profile-photo {
        border-color: #555;
    }
    .username {
        font-size: 0.9em;
        font-weight: bold;
        color: var(--text-color);
    }
    .dark .username {
        color: #ccc;
    }
    .message-box {
        word-wrap: break-word;
    }
    .chat-input {
        display: flex;
        margin-top: 10px;
        align-items: center;
        gap: 10px;
    }
    #chat-message {
        flex: 3;
        height: 40px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 14px;
        color: var(--text-color);
        background: var(--container-bg);
        box-sizing: border-box;
    }
    #chat-message::placeholder {
        color: #888;
    }
    .dark #chat-message {
        border-color: #555;
    }
    .dark #chat-message::placeholder {
        color: #aaa;
    }
    #send-message {
        flex: 1;
        height: 40px;
        padding: 8px 15px;
        margin-top: 0;
        background: var(--button-bg);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        box-sizing: border-box;
    }
    .dark #send-message {
        border: 1px solid #555;
    }
    #send-message:hover {
        background: var(--button-hover);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const gameId = {{ game_id }};
        const username = '{{ request.user.username }}';
        const chatWsUrl = (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/chat/' + gameId + '/';
        console.log('Chat WebSocket URL:', chatWsUrl);

        let chatWs;
        function connectWebSocket() {
            chatWs = new WebSocket(chatWsUrl);
            chatWs.onopen = () => console.log('Chat WebSocket connected for game ' + gameId);
            chatWs.onmessage = (event) => {
                console.log('Received WebSocket message:', event.data);
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'chat_message') {
                        const chatMessages = document.getElementById('chat-messages');
                        const messageDiv = document.createElement('div');
                        messageDiv.className = data.username === username ? 'message my-message' : 'message other-message';

                        // Header with username and profile photo
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'header';

                        const usernameSpan = document.createElement('span');
                        usernameSpan.className = 'username';
                        usernameSpan.textContent = data.username;

                        const photoImg = document.createElement('img');
                        photoImg.className = 'profile-photo';
                        photoImg.src = data.profile_photo || 'https://via.placeholder.com/24';
                        photoImg.onerror = () => console.error(`Failed to load profile photo: ${data.profile_photo}`);

                        if (data.username === username) {
                            // Your message: username on left, photo on right
                            headerDiv.appendChild(usernameSpan);
                            headerDiv.appendChild(photoImg);
                        } else {
                            // Others' message: photo on left, username on right
                            headerDiv.appendChild(photoImg);
                            headerDiv.appendChild(usernameSpan);
                        }

                        // Message content inside a box
                        const messageBox = document.createElement('div');
                        messageBox.className = 'message-box';
                        messageBox.textContent = data.message;

                        messageDiv.appendChild(headerDiv);
                        messageDiv.appendChild(messageBox);

                        chatMessages.appendChild(messageDiv);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    } else if (data.type === 'error') {
                        console.error('Chat error:', data.message);
                    }
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };
            chatWs.onerror = (error) => console.error('Chat WebSocket error:', error);
            chatWs.onclose = (event) => {
                console.log('Chat WebSocket closed for game ' + gameId, event);
                setTimeout(connectWebSocket, 3000);
            };
        }

        connectWebSocket();

        document.getElementById('send-message').onclick = () => {
            const messageInput = document.getElementById('chat-message');
            const message = messageInput.value.trim();
            if (message) {
                if (chatWs.readyState === WebSocket.OPEN) {
                    console.log('Sending message:', message);
                    chatWs.send(JSON.stringify({ 'message': message }));
                    messageInput.value = '';
                } else {
                    console.error('WebSocket is not open. Current state:', chatWs.readyState);
                }
            }
        };
        document.getElementById('chat-message').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('send-message').click();
            }
        });
    });
</script>