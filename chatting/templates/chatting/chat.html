<div class="chat-container">
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-input">
        <input type="text" id="chat-message" placeholder="Type a message..." />
        <button id="send-message">Send</button>
    </div>
</div>

<style>
    .chat-container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        border-radius: 8px;
        padding: 15px;
        box-sizing: border-box;
    }
    .chat-messages {
        flex: 1;
        background: var(--chat-bg);
        overflow-y: auto;
        padding: 10px;
        border-radius: 8px;
    }
    .message {
        margin: 5px 0;
        padding: 8px 12px;
        border-radius: 8px;
        max-width: 70%;
        word-wrap: break-word;
        display: flex;
        align-items: center;
    }
    .my-message {
        background: var(--my-message-bg);
        color: #fff;
        margin-left: auto;
        text-align: right;
    }
    .other-message {
        background: var(--other-message-bg);
        color: var(--text-color);
        margin-right: auto;
        display: flex;
        align-items: center;
    }
    .username {
        font-weight: bold;
        margin-right: 8px;
    }
    .chat-input {
        display: flex;
        margin-top: 10px;
        align-items: center;
        gap: 10px;
    }
    #chat-message {
        flex: 3;
        height: 40px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 14px;
        color: var(--text-color);
        background: var(--container-bg);
        box-sizing: border-box;
    }
    #chat-message::placeholder {
        color: #888;
    }
    .dark #chat-message {
        border-color: #555;
    }
    .dark #chat-message::placeholder {
        color: #aaa;
    }
    #send-message {
        flex: 1;
        height: 40px;
        padding: 8px 15px;
        margin-top: 0;
        background: var(--button-bg);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        box-sizing: border-box;
    }
    .dark #send-message {
        border: 1px solid #555;
    }
    #send-message:hover {
        background: var(--button-hover);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const gameId = {{ game_id }};
        const username = '{{ request.user.username }}';
        const chatWsUrl = (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/chat/' + gameId + '/';
        console.log('Chat WebSocket URL:', chatWsUrl);

        const chatWs = new WebSocket(chatWsUrl);
        chatWs.onopen = () => console.log('Chat WebSocket connected for game ' + gameId);
        chatWs.onmessage = (event) => {
            console.log('Received WebSocket message:', event.data);
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'chat_message') {
                    const chatMessages = document.getElementById('chat-messages');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = data.username === username ? 'message my-message' : 'message other-message';

                    if (data.username === username) {
                        // Your message (right side)
                        messageDiv.textContent = `${data.username}: ${data.message}`;
                    } else {
                        // Others' message (left side, username to the left)
                        const usernameSpan = document.createElement('span');
                        usernameSpan.className = 'username';
                        usernameSpan.textContent = data.username;
                        const messageSpan = document.createElement('span');
                        messageSpan.textContent = data.message;
                        messageDiv.appendChild(usernameSpan);
                        messageDiv.appendChild(messageSpan);
                    }

                    chatMessages.appendChild(messageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else if (data.type === 'error') {
                    console.error('Chat error:', data.message);
                }
            } catch (error) {
                console.error('Error parsing WebSocket message:', error);
            }
        };
        chatWs.onerror = (error) => console.error('Chat WebSocket error:', error);
        chatWs.onclose = (event) => console.log('Chat WebSocket closed for game ' + gameId, event);

        document.getElementById('send-message').onclick = () => {
            const messageInput = document.getElementById('chat-message');
            const message = messageInput.value.trim();
            if (message) {
                console.log('Sending message:', message);
                chatWs.send(JSON.stringify({ 'message': message }));
                messageInput.value = '';
            }
        };
        document.getElementById('chat-message').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('send-message').click();
            }
        });
    });
</script>