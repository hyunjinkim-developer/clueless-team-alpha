        // Initialize WebSocket connection
        const gameId = {{ game_id }};
        const ws = new WebSocket('ws://' + window.location.host + '/ws/game/' + gameId + '/');
        const historyList = document.getElementById('history-list');
        const actionHistory = []; // Array to store popup actions


        // Log WebSocket connection success
        ws.onopen = function() {
            console.log("WebSocket connected successfully");
        };

        // Handle WebSocket messages
        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                console.log('Received WebSocket message:', data);
                const notification = document.getElementById('notification');
                if (!notification) {
                    console.error('Notification element not found');
                    return;
                }
                if (data.type === 'game_update') {
                    console.log('Game state players:', data.game_state.players);
                    updateGameBoard(data.game_state);
                }  else if (data.type === 'popup') {
                    showPopup(data.message);
                }  else if (data.type === 'select_card') {
                    // Handle the card selection popup
                    const matchList = data.matchList;
                    const message = data.message;
                    const suggestingPlayerChannel = data.suggesting_player_channel;

                    // Create a popup for card selection
                    const popup = document.createElement('div');
                    popup.style.position = 'fixed';
                    popup.style.top = '50%';
                    popup.style.left = '50%';
                    popup.style.transform = 'translate(-50%, -50%)';
                    popup.style.backgroundColor = '#fff';
                    popup.style.padding = '20px';
                    popup.style.borderRadius = '10px';
                    popup.style.boxShadow = '0px 4px 8px rgba(0, 0, 0, 0.2)';
                    popup.style.zIndex = '1000';
                    popup.style.textAlign = 'center';

                    const messageElement = document.createElement('p');
                    messageElement.textContent = message;
                    messageElement.style.color = 'black'; // Set text color to black
                    popup.appendChild(messageElement);

                    // Create buttons for each card in matchList
                    matchList.forEach(card => {
                        const button = document.createElement('button');
                        button.textContent = card;
                        button.style.margin = '5px';
                        button.style.padding = '10px';
                        button.style.border = '1px solid #ccc';
                        button.style.borderRadius = '5px';
                        button.style.cursor = 'pointer';
                        button.addEventListener('click', () => {
                            // Send the selected card back to the server
                            ws.send(JSON.stringify({
                                type: 'card_selected',
                                card: card,
                                suggesting_player_channel: suggestingPlayerChannel
                            }));
                            document.body.removeChild(popup); // Remove the popup
                        });
                        popup.appendChild(button);
                    });

                    document.body.appendChild(popup);
                } else if (data.type === 'game_end') {
                    const { winner, solution, message } = data;
                    // Update notification with game end message
                    notification.innerHTML = `<p>${message}</p>`;
                    // Disable accusations button
                    const accusationsButton = document.getElementById('accusations-button');
                    if (accusationsButton) accusationsButton.disabled = true;
                    setTimeout(() => {
                        alert(`${message}\nSolution: ${solution.suspect} in ${solution.room} with ${solution.weapon}`);
                    }, 1000);
                } else if (data.type === 'game_tie') {
                    // Update notification with tie message
                    notification.innerHTML = `<p>${data.message}</p>`;
                    // Disable all action buttons
                    const buttons = ['accusations-button', 'suggestions-button', 'end-turn-button', 'display-hand-button', 'toggle-history-button'];
                    buttons.forEach(id => {
                        const btn = document.getElementById(id);
                        if (btn) btn.disabled = true;
                    });
                    alert(data.message);
                } else if (data.type === 'accusation_failed') {
                    // Append accusation failure message to notification
                    document.getElementById('notification').innerHTML += `<p>${data.message}</p>`;
                    alert(data.message);
                    // Disable action buttons
                    const buttons = ['accusations-button', 'suggestions-button', 'end-turn-button', 'display-hand-button', 'toggle-history-button'];
                    buttons.forEach(id => {
                        const btn = document.getElementById(id);
                        if (btn) btn.disabled = true;
                    });
                } else if (data.type === 'player_eliminated') {
                    // Append elimination message to notification
                    document.getElementById('notification').innerHTML += `<p>${data.message}</p>`;
                    alert(data.message);
                } else if (data.error) {
                    console.error('Error:', data.error);
                    alert(data.error);
                }
            } catch (e) {
                console.error('Error processing WebSocket message:', e);
            }
        };

        // Log WebSocket errors
        ws.onerror = function(error) {
            console.error("WebSocket connection error:", error);
        };

        // Log WebSocket closure
        ws.onclose = function() {
            console.log("WebSocket closed");
        };